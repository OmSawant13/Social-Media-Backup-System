<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        input,
        button {
            padding: 10px;
            margin: 10px;
            display: block;
        }
        
        .error {
            color: red;
        }
        
        .success {
            color: green;
        }
    </style>
</head>

<body>
    <h1>Upload Test</h1>

    <input type="file" id="file-input">
    <input type="text" id="caption" placeholder="Caption" value="Test caption">
    <button id="upload-btn">Upload</button>

    <div id="result"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAbMhL5bnIIVB-_MkIF1ZSrtdxKx0MyJok",
            authDomain: "rdsem-a00a4.firebaseapp.com",
            projectId: "rdsem-a00a4",
            storageBucket: "rdsem-a00a4.firebasestorage.app",
            messagingSenderId: "272667034179",
            appId: "1:272667034179:web:3067641ac46d88c96d8af6",
            measurementId: "G-GN5VC6VJKF"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        console.log('Firebase initialized!');

        // Test upload
        document.getElementById('upload-btn').addEventListener('click', async() => {
            const fileInput = document.getElementById('file-input');
            const caption = document.getElementById('caption').value;
            const resultDiv = document.getElementById('result');

            console.log('Upload button clicked!');
            console.log('File:', fileInput.files[0]);
            console.log('Caption:', caption);

            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">Please select a file</div>';
                return;
            }

            if (!caption.trim()) {
                resultDiv.innerHTML = '<div class="error">Please add caption</div>';
                return;
            }

            resultDiv.innerHTML = 'Uploading...';

            try {
                const file = fileInput.files[0];
                const user = auth.currentUser;

                console.log('User:', user);

                if (!user) {
                    resultDiv.innerHTML = '<div class="error">Please login first</div>';
                    return;
                }

                // Upload to Cloudinary (FREE alternative to Firebase Storage)
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'ml_default'); // Default preset

                try {
                    const response = await fetch('https://api.cloudinary.com/v1_1/demo/image/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    console.log('Cloudinary upload result:', result);

                    // Save to Firestore with Cloudinary URL
                    await db.collection('backups').add({
                        userId: user.uid,
                        fileName: file.name,
                        fileSize: file.size,
                        mimeType: file.type,
                        caption: caption,
                        downloadURL: result.secure_url, // Real file URL
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    resultDiv.innerHTML = '<div class="success">✅ Upload successful!</div>';
                    console.log('Upload completed!');
                } catch (error) {
                    console.error('Cloudinary upload error:', error);
                    resultDiv.innerHTML = `<div class="error">❌ Upload failed: ${error.message}</div>`;
                }

            } catch (error) {
                console.error('Upload error:', error);
                resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        });

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User signed in:', user.email);
                document.getElementById('result').innerHTML = `<div class="success">Logged in as: ${user.email}</div>`;
            } else {
                console.log('User signed out');
                document.getElementById('result').innerHTML = '<div class="error">Please login first</div>';
            }
        });
    </script>
</body>

</html>